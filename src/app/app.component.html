<main>
  <div class="placeholder">

    <!-- HEADER Z LOGO, DATÄ„ I AUDIO -->
    <div class="header">
      <!-- UkÅ‚ad dwukolumnowy: Lewa (logo+tytuÅ‚) | Prawa (data+audio) -->
      <div class="header-top-line">
        <!-- LEWA STRONA: Logo + TytuÅ‚ gÅ‚Ã³wny -->
        <div class="left-column">
          <div class="logo-section">
            <img src="assets/source.png" alt="Logo" 
                 (load)="onImageLoad($event)" 
                 (error)="onImageError($event)"
                 loading="lazy" />
          </div>
          <div class="header-title">
            <h1>DROGA MARYI <br>33 - dniowe rekolekcje<br> 5 XI do 8 XII {{ currentDateTime | date:'yyyy' }} r.</h1>
          </div>
        </div>
        
        <!-- PRAWA STRONA: Data + Audio -->
        <div class="right-column">
          <div class="date-section">
            <div class="date-line">{{ currentDateTime | date:'EEEE dd.MM.yyyy':'':'pl-PL' }} r.</div>
            <div class="totus-image">
              <img src="assets/totatua.png" alt="Totus Tuus" 
                   (load)="onImageLoad($event)" 
                   (error)="onImageError($event)"
                   loading="lazy" />
            </div>
          </div>
          <div class="audio-section">
            <button (click)="toggleAudio()" 
                    class="audio-toggle-btn"
                    [class.playing]="isAudioPlaying"
                    title="{{isAudioPlaying ? 'Zatrzymaj' : 'OdtwÃ³rz'}} melodiÄ™ Totus Tuus">
              <span class="play-icon">{{isAudioPlaying ? 'â¸ï¸' : 'â–¶ï¸'}}</span>
              <span class="audio-title">Totus Tuus</span>
              <span class="audio-status">{{isAudioPlaying ? 'Odtwarzanie...' : 'NaciÅ›nij aby odtworzyÄ‡'}}</span>
            </button>
          </div>
        </div>
      </div>
      
      <!-- PodtytuÅ‚ na caÅ‚Ä… szerokoÅ›Ä‡ -->
      <div class="header-subtitle">
        <p>Nowenna do Å›w. Ludwika i 33 dniowe rozwaÅ¼ania</p>
      </div>
    </div>

    <div class="divider"></div>

    <!-- EVENTY -->
    <div *ngFor="let item of items; trackBy: trackByTitle" class="event-card">

      <!-- NagÅ‚Ã³wek wydarzenia -->
      <div class="event-header" (click)="toggle(item)">
  <span *ngIf="isTodayInTitleRange(item.title) || hasInnerTodayGroups(item)">ğŸ‘‰</span>
  <span>ğŸ“Œ <span [innerHTML]="item.title"></span></span>
  <span>{{ item.show ? 'â–²' : 'â–¼' }}</span>
      </div>

      <!-- ZawartoÅ›Ä‡ wydarzenia -->
      <div class="pill-group" *ngIf="item.show">

        <!-- Miniatura obrazka wydarzenia -->
        <div class="event-image-container" *ngIf="item.image">
          <img [src]="item.image"
               alt="Obraz wydarzenia"
               class="event-thumb"
               (click)="toggleFullscreen(item.image); $event.stopPropagation();" />

          <div class="fullscreen-local" *ngIf="fullscreenImage === item.image" (click)="toggleFullscreen(item.image)">
            <img [src]="item.image" class="fullscreen-local-image" />
          </div>
        </div>

        <!-- GRUPY LINKÃ“W I OPISY -->
        <div class="groups-container">
          <ng-container *ngFor="let group of item.links; trackBy: trackByName">

            <!-- Miniaturka grupy -->
            <div class="event-image-container" *ngIf="group.image">
              <img [src]="group.image"
                   alt="Obraz grupy"
                   class="event-thumb"
                   (click)="toggleFullscreen(group.image); $event.stopPropagation();" />

              <div class="fullscreen-local" *ngIf="fullscreenImage === group.image" (click)="toggleFullscreen(group.image)">
                <img [src]="group.image" class="fullscreen-local-image" />
              </div>
            </div>

            <!-- GÅÃ“WNY LINK GRUPY (tylko jeÅ›li jest jeden link) -->
            <a *ngIf="group.type !== 'opis' && group.links?.length === 1 && group.links?.[0]?.url"
               class="grid-link main-link"
               [class.today-highlight]="group.name ? isToday(group.name) : false"
               [href]="getMainLink(group)"
               target="_blank"
               rel="noopener"
               (click)="$event.stopPropagation()">
              <span *ngIf="group.name && isToday(group.name)">ğŸ‘‰</span>
              {{ group.name }}
            </a>

            <!-- OPIS -->
            <div *ngIf="group.type==='opis'" class="grid-link description-link" (click)="openOnly(group, item)">
              <span *ngIf="(group.name && isToday(group.name)) || hasInnerTodayElements(group)">ğŸ‘‰</span>
              <span *ngIf="group.protected">ğŸ”’</span>
              <span *ngIf="!group.protected">ğŸ“</span>
              {{ group.name }}

              <div *ngIf="group.show && group.text" class="event-description">
                <div class="justified-text" [innerHTML]="processTextWithLinks(group.text)"></div>
              </div>
            </div>

            <!-- GRUPA Z WIELOMA LINKAMI (nie jest opisem i ma wiÄ™cej niÅ¼ 1 link) -->
            <div *ngIf="group.type !== 'opis' && group.links && group.links.length > 1" 
                 class="group-container"
                 [class.expanded]="group.show"
                 [class.today-highlight]="group.name ? isToday(group.name) : false">
                 
              <!-- GÅ‚Ã³wny link grupy -->
              <div class="grid-link main-link"
                   [class.today-highlight]="group.name ? isToday(group.name) : false"
                   (click)="openOnly(group, item)">
                <span *ngIf="(group.name && isToday(group.name)) || hasInnerTodayElements(group)">ğŸ‘‰</span>
                <span class="expand-icon">{{ group.show ? 'â–¼' : 'â–¶' }}</span>
                <span>ğŸ“</span>
                {{ group.name }}
              </div>

              <!-- PODLINKI (grupy z wieloma linkami) -->
              <ng-container *ngIf="group.show && group.links as links">
                <div *ngIf="links.length > 1" class="sub-links-container">
                  <div class="connection-line"></div>
                  <div class="link-grid" [class.photo-grid]="hasPhotoElements(links)">
                <ng-container *ngFor="let l of links">
                  
                  <!-- JeÅ›li link ma zagnieÅ¼dÅ¼one linki (drugi poziom) -->
                  <ng-container *ngIf="l.links && l.links.length > 0">
                    <div class="nested-group">
                      <div class="nested-header" (click)="toggleNestedGroup(l)">
                        <span class="nested-icon">{{ l.show ? 'â–¼' : 'â–¶' }}</span>
                        <span [ngSwitch]="l.type">
                          <span *ngSwitchCase="'film'">ğŸ¬</span>
                          <span *ngSwitchCase="'pdf'">ğŸ“•</span>
                          <span *ngSwitchCase="'exec'">ğŸ’¿</span>
                          <span *ngSwitchCase="'foto'">ğŸ“·</span>
                          <span *ngSwitchCase="'audio'">ğŸµ</span>
                          <span *ngSwitchCase="'youtube'">ğŸ“º</span>
                          <span *ngSwitchCase="'html'">ğŸŒ</span>
                          <span *ngSwitchDefault>ğŸ“</span>
                        </span>
                        {{ l.name || l.label || 'Grupa zagnieÅ¼dÅ¼ona' }}
                      </div>
                      
                      <!-- ZagnieÅ¼dÅ¼one linki -->
                      <div *ngIf="l.show" class="nested-links">
                        <a *ngFor="let nestedLink of l.links"
                           class="grid-link nested-link"
                           [class.today-highlight]="(nestedLink.label || nestedLink.url) ? isToday(nestedLink.label || nestedLink.url || '') : false"
                           [href]="nestedLink.url || null"
                           target="_blank"
                           rel="noopener"
                           (click)="$event.stopPropagation()">

                          <span *ngIf="(nestedLink.label || nestedLink.url) && isToday(nestedLink.label || nestedLink.url || '')">ğŸ‘‰</span>
                          <span class="sub-icon">â¤â¤</span>

                          <span [ngSwitch]="nestedLink.type">
                            <span *ngSwitchCase="'film'">ğŸ¬</span>
                            <span *ngSwitchCase="'pdf'">ğŸ“•</span>
                            <span *ngSwitchCase="'exec'">ğŸ’¿</span>
                            <span *ngSwitchCase="'foto'">ğŸ“·</span>
                            <span *ngSwitchCase="'audio'">ğŸµ</span>
                            <span *ngSwitchCase="'youtube'">ğŸ“º</span>
                            <span *ngSwitchCase="'html'">ğŸŒ</span>
                            <span *ngSwitchDefault>ğŸ“</span>
                          </span>

                          {{ nestedLink.label || nestedLink.url }}
                        </a>
                      </div>
                    </div>
                  </ng-container>

                  <!-- ZwykÅ‚y link (bez zagnieÅ¼dÅ¼onych linkÃ³w) -->
                  <ng-container *ngIf="!l.links || l.links.length === 0">
                    
                    <!-- Element foto (tylko zdjÄ™cie) -->
                    <div *ngIf="l.type==='foto'" 
                         class="grid-link sub-link foto-item"
                         [class.today-highlight]="(l.label || l.url) ? isToday(l.label || l.url || '') : false">
                      
                      <div class="link-thumb-container">
                        <img [src]="l.image" 
                             alt="Miniaturka" 
                             class="link-thumb"
                             loading="lazy"
                             decoding="async"
                             (load)="onImageLoad($event)"
                             (error)="onImageError($event)"
                             (click)="toggleFullscreen(l.image); $event.preventDefault(); $event.stopPropagation();" />

                      </div>
                      
                      <span *ngIf="(l.label || l.url) && isToday(l.label || l.url || '')">ğŸ‘‰</span>
                    </div>

                    <!-- Element tekstowy (opis w podlinku) -->
                    <div *ngIf="l.type==='opis' && l.text" class="grid-link sub-link text-item">
                      
                      <!-- Etykieta gdy tekst jest zwiniÄ™ty -->
                      <div *ngIf="!l.show" class="text-collapsed-header" (click)="toggleTextVisibility(l); $event.stopPropagation();">
                        <div class="text-collapsed-left">
                          <span class="text-icon">ğŸ“</span>
                          <span class="text-toggle-label">{{ l.label || 'CzuÅ‚e serce Å›w. Ludwika' }}</span>
                        </div>
                        <span class="text-toggle-icon">â–¼</span>
                      </div>
                      
                      <!-- Przycisk toggle w prawym gÃ³rnym rogu gdy tekst jest rozwiniÄ™ty -->
                      <div *ngIf="l.show" class="text-toggle-container">
                        <span class="text-toggle-icon" (click)="toggleTextVisibility(l); $event.stopPropagation();">â–²</span>
                        <span class="copy-text-icon" (click)="copyTextToClipboard(l.text); $event.stopPropagation();" title="Skopiuj tekst">ğŸ“‹</span>
                      </div>
                      
                      <!-- ZawartoÅ›Ä‡ tekstowa -->
                      <div *ngIf="l.show" class="sub-text" [innerHTML]="processTextWithLinks(l.text)">
                      </div>
                    </div>

                    <!-- ZwykÅ‚y link (z URL) -->
                    <a *ngIf="l.type!=='foto' && l.type!=='opis'"
                       class="grid-link sub-link"
                       [class.today-highlight]="(l.label || l.url) ? isToday(l.label || l.url || '') : false"
                       [href]="l.url || null"
                       target="_blank"
                       rel="noopener"
                       (click)="$event.stopPropagation()">

                      <span *ngIf="(l.label || l.url) && isToday(l.label || l.url || '')">ğŸ‘‰</span>
                      <span class="sub-icon">â¤</span>

                      <span [ngSwitch]="l.type">
                        <span *ngSwitchCase="'film'">ğŸ¬</span>        
                        <span *ngSwitchCase="'pdf'">ğŸ“•</span>
                        <span *ngSwitchCase="'exec'">ğŸ’¿</span>
                        <span *ngSwitchCase="'foto'">ğŸ“·</span>
                        <span *ngSwitchCase="'audio'">ğŸµ</span>
                        <span *ngSwitchCase="'youtube'">ğŸ“º</span>
                        <span *ngSwitchCase="'html'">ğŸŒ</span>
                        <span *ngSwitchDefault>ğŸ“</span>
                      </span>

                      {{ l.label || l.url }}
                    </a>
                  </ng-container>
                </ng-container>
                  </div>
                </div>
              </ng-container>
            </div>

          </ng-container>
        </div>

      </div>
    </div>

    <!-- Stopka z przyciskiem -->
    <div class="footer-section">
      <div style="display: flex; justify-content: space-between; align-items: center; width: 100%;">
        <div style="font-size: 0.95em; color: #666;">Opracowano na podstawie <a href='https://drogamaryi.pl/' target='_blank' rel='noopener'>https://drogamaryi.pl/</a> <br>Do uÅ¼ytku wewnÄ™trznego wspÃ³lnoty.</div>
        <div class="znak-wodny">
          Â© <span class="ozdobne">EO</span>
        </div>
      </div>
      <button class="close-button" (click)="closePage()">
        <span class="close-icon">Ã—</span>
        <span class="close-text">Zamknij stronÄ™</span>
      </button>
    </div>

  </div>

  <!-- FULLSCREEN IMAGE - poza wszystkimi kontenerami -->
  <div class="fullscreen-local" *ngIf="fullscreenImage" (click)="toggleFullscreen()">
    <img [src]="fullscreenImage" 
         class="fullscreen-local-image"
         loading="eager"
         decoding="async" />
  </div>
</main>
